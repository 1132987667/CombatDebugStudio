## 问题分析

回合顺序错乱的根本原因是：

1. **回合号计算错误**：`syncBattleLogs` 方法使用 `battleState.currentTurn + 1` 计算回合号，但这是战斗系统当前的回合索引，而不是每个 action 实际发生的回合

2. **批量处理导致的回合号重复**：当多个 action 被批量处理时，它们都会使用相同的 `battleState.currentTurn` 值，导致所有 action 都被分配到同一个回合

3. **缺少 action 与回合的关联**：每个 action 没有明确记录自己属于哪个回合

## 修复方案

### 1. 修改 BattleSystem.ts

1. **在 BattleAction 接口中添加 turn 属性**：
   - 在 `src/types/battle.ts` 中为 BattleAction 接口添加可选的 turn 属性

2. **在 processTurn 方法中设置 action 的 turn 属性**：
   - 在执行 action 前，设置 action.turn = battle.currentTurn + 1
   - 确保每个 action 都记录自己实际发生的回合

### 2. 修改 BattleArena.vue

1. **修改 syncBattleLogs 方法**：
   - 使用 action.turn 而不是 battleState.currentTurn 来计算回合号
   - 按 action 的时间戳和回合号排序后再显示日志

2. **优化日志显示顺序**：
   - 在添加日志前，按 action 的 timestamp 排序
   - 确保日志按时间顺序和回合顺序正确显示

### 3. 测试验证

1. **功能测试**：
   - 开始新战斗，验证日志显示的回合顺序是否正确
   - 检查每个 action 是否显示在正确的回合中

2. **边界测试**：
   - 测试多回合战斗，确保回合号递增正确
   - 测试自动战斗模式，确保大量 action 的顺序正确

## 预期效果

修复后，战斗日志应该按正确的回合顺序显示：

```
系统 系统 对  战斗开始！参战角色: 3 人，参战敌人: 2 人
回合1 幼年山魈 消耗 100 能量，对 成年山魈 使用 终极技能，造成 80 伤害
回合1 成年山魈 消耗 50 能量，对 花妖 使用 爪击，造成 25 伤害
回合1 花妖 消耗 100 能量，对 成年山魈 使用 终极技能，造成 80 伤害
回合2 幼年山魈 消耗 100 能量，对 成年山魈 使用 终极技能，造成 80 伤害
...
系统 系统 对  战斗结束！胜利者: 角色方
```