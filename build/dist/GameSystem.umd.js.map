{"version":3,"file":"GameSystem.umd.js","sources":["../../src/utils/logger.ts","../../src/core/BuffScriptRegistry.ts","../../src/core/BuffContext.ts","../../src/core/ModifierStack.ts","../../src/core/BuffErrorBoundary.ts","../../src/core/BuffSystem.ts","../../src/core/BuffScriptLoader.ts","../../src/core/BattleAI.ts","../../src/core/BattleSystem.ts","../../src/utils/perf-monitor.ts","../../src/utils/object-pool.ts","../../src/utils/schema-validator.ts","../../src/scripts/base/BaseBuffScript.ts","../../src/scripts/base/BuffScriptUtils.ts","../../src/scripts/combat/MountainGodBuff.ts","../../src/scripts/combat/PoisonDebuff.ts","../../src/scripts/combat/BerserkBuff.ts","../../src/scripts/support/HealOverTime.ts","../../src/scripts/support/ShieldBuff.ts","../../src/scripts/index.ts","../../src/index.ts"],"sourcesContent":["export type LogLevel = 'DEBUG' | 'INFO' | 'WARN' | 'ERROR'\n\ninterface LoggerConfig {\n  level: LogLevel\n  prefix: string\n  enableColors: boolean\n}\n\nclass Logger {\n  private config: LoggerConfig\n\n  constructor(config: Partial<LoggerConfig> = {}) {\n    this.config = {\n      level: config.level || 'INFO',\n      prefix: config.prefix || 'BuffSystem',\n      enableColors: config.enableColors ?? true\n    }\n  }\n\n  private shouldLog(level: LogLevel): boolean {\n    const levels: LogLevel[] = ['DEBUG', 'INFO', 'WARN', 'ERROR']\n    return levels.indexOf(level) >= levels.indexOf(this.config.level)\n  }\n\n  private formatMessage(level: LogLevel, message: string, data?: any): string {\n    const timestamp = new Date().toISOString()\n    let formatted = `[${timestamp}] [${this.config.prefix}] [${level}] ${message}`\n\n    if (data) {\n      formatted += `\\n${JSON.stringify(data, null, 2)}`\n    }\n\n    return formatted\n  }\n\n  private log(level: LogLevel, message: string, data?: any): void {\n    if (!this.shouldLog(level)) return\n\n    const formatted = this.formatMessage(level, message, data)\n\n    switch (level) {\n      case 'DEBUG':\n        console.debug(formatted)\n        break\n      case 'INFO':\n        console.info(formatted)\n        break\n      case 'WARN':\n        console.warn(formatted)\n        break\n      case 'ERROR':\n        console.error(formatted)\n        break\n      default:\n        console.log(formatted)\n        break\n    }\n  }\n\n  public debug(message: string, data?: any): void {\n    this.log('DEBUG', message, data)\n  }\n\n  public info(message: string, data?: any): void {\n    this.log('INFO', message, data)\n  }\n\n  public warn(message: string, data?: any): void {\n    this.log('WARN', message, data)\n  }\n\n  public error(message: string, data?: any): void {\n    this.log('ERROR', message, data)\n  }\n\n  public setLevel(level: LogLevel): void {\n    this.config.level = level\n  }\n\n  public setPrefix(prefix: string): void {\n    this.config.prefix = prefix\n  }\n}\n\nexport const logger = new Logger()\nexport { Logger }\n","import { IBuffScript } from '@/types/buff';\r\nimport { Logger } from '@/utils/logger'; \r\n\r\ntype ScriptFactory<TParams = any> = () => IBuffScript<TParams>; \r\n\r\ninterface RegistryEntry<TParams = any> { \r\n  factory: ScriptFactory<TParams>; \r\n  metadata: { \r\n    scriptId: string; \r\n    filePath: string; \r\n    loadTime: number; \r\n    version?: string; \r\n  }; \r\n} \r\n\r\nexport class BuffScriptRegistry { \r\n  private static instance: BuffScriptRegistry;\r\n  private registry = new Map<string, RegistryEntry>();\r\n  private readonly logger = new Logger({ prefix: 'BuffScriptRegistry' });\r\n\r\n  private constructor() {} \r\n\r\n  public static getInstance(): BuffScriptRegistry { \r\n    if (!BuffScriptRegistry.instance) { \r\n      BuffScriptRegistry.instance = new BuffScriptRegistry(); \r\n    } \r\n    return BuffScriptRegistry.instance; \r\n  } \r\n\r\n  // 手动注册（推荐方式） \r\n  public register<TParams = any>(scriptId: string, factory: ScriptFactory<TParams>, metadata?: Partial<RegistryEntry['metadata']>): void { \r\n    if (this.registry.has(scriptId)) { \r\n      this.logger.warn(`Script \"${scriptId}\" already registered, overwriting`); \r\n    } \r\n\r\n    this.registry.set(scriptId, { \r\n      factory, \r\n      metadata: { \r\n        scriptId, \r\n        filePath: metadata?.filePath ?? 'unknown', \r\n        loadTime: Date.now(), \r\n        version: metadata?.version \r\n      } \r\n    }); \r\n\r\n    this.logger.info(`Registered buff script: ${scriptId}`); \r\n  } \r\n\r\n  // 安全获取（带类型推断） \r\n  public get<TParams = any>(scriptId: string): IBuffScript<TParams> | null { \r\n    const entry = this.registry.get(scriptId); \r\n    if (!entry) { \r\n      this.logger.error(`Buff script not found: ${scriptId}`); \r\n      return null; \r\n    } \r\n\r\n    try { \r\n      return entry.factory(); \r\n    } catch (e) { \r\n      this.logger.error(`Failed to instantiate script \"${scriptId}\":`, e); \r\n      return null; \r\n    } \r\n  } \r\n\r\n  // 批量注册（用于自动加载） \r\n  public batchRegister(entries: { scriptId: string; factory: ScriptFactory; filePath: string }[]): void { \r\n    entries.forEach(entry => { \r\n      this.register(entry.scriptId, entry.factory, { filePath: entry.filePath }); \r\n    }); \r\n  } \r\n\r\n  public has(scriptId: string): boolean { \r\n    return this.registry.has(scriptId); \r\n  } \r\n\r\n  public list(): string[] { \r\n    return Array.from(this.registry.keys()); \r\n  } \r\n\r\n  // 热重载支持：卸载旧版本 \r\n  public unregister(scriptId: string): boolean { \r\n    return this.registry.delete(scriptId); \r\n  } \r\n}","import type { BuffConfig } from '@/types/buff'\r\nimport type { Character } from '@/types/character'\r\nimport { BuffSystem } from './BuffSystem'\r\n\r\nexport class BuffContext {\r\n  public readonly characterId: string\r\n  public readonly instanceId: string\r\n  public readonly config: BuffConfig\r\n  public readonly startTime: number\r\n  public variables = new Map<string, any>()\r\n\r\n  constructor(\r\n    characterId: string,\r\n    instanceId: string,\r\n    config: BuffConfig\r\n  ) {\r\n    this.characterId = characterId\r\n    this.instanceId = instanceId\r\n    this.config = config\r\n    this.startTime = Date.now()\r\n  }\r\n\r\n  public getElapsedTime(): number {\r\n    return Date.now() - this.startTime\r\n  }\r\n\r\n  public getRemainingTime(): number {\r\n    if (this.config.duration <= 0) {\r\n      return -1\r\n    }\r\n    return Math.max(0, this.config.duration - this.getElapsedTime())\r\n  }\r\n\r\n  public setVariable(key: string, value: any): void {\r\n    this.variables.set(key, value)\r\n  }\r\n\r\n  public getVariable<T>(key: string): T | undefined {\r\n    return this.variables.get(key) as T\r\n  }\r\n\r\n  public removeVariable(key: string): void {\r\n    this.variables.delete(key)\r\n  }\r\n\r\n  public addModifier(\r\n    attribute: string,\r\n    value: number,\r\n    type: 'ADDITIVE' | 'MULTIPLICATIVE' | 'PERCENTAGE'\r\n  ): void {\r\n    const system = BuffSystem.getInstance()\r\n    const modifierStack = system.getModifierStack(this.characterId)\r\n    modifierStack.addModifier(\r\n      this.instanceId,\r\n      attribute as any,\r\n      value,\r\n      type\r\n    )\r\n  }\r\n\r\n  public removeModifiers(): void {\r\n    const system = BuffSystem.getInstance()\r\n    const modifierStack = system.getModifierStack(this.characterId)\r\n    modifierStack.removeModifier(this.instanceId)\r\n  }\r\n\r\n  public getCharacter(): Character | undefined {\r\n    // 这里应该从角色系统获取角色实例\r\n    // 暂时返回 undefined，实际实现需要集成角色系统\r\n    return undefined\r\n  }\r\n\r\n  public getAttributeValue(attribute: string): number {\r\n    const character = this.getCharacter()\r\n    if (character) {\r\n      return character.getAttribute(attribute as any)\r\n    }\r\n    return 0\r\n  }\r\n\r\n  public triggerEvent(eventName: string, data?: any): void {\r\n    // 这里应该触发游戏事件系统\r\n    console.log(`Buff event triggered: ${eventName}`, data)\r\n  }\r\n}\r\n","import type { Modifier, ModifierType, AttributeType } from '@/types/modifier'\r\n\r\nexport class ModifierStack {\r\n  private modifiers = new Map<string, Modifier[]>()\r\n\r\n  public addModifier(\r\n    buffInstanceId: string,\r\n    attribute: AttributeType,\r\n    value: number,\r\n    type: ModifierType\r\n  ): void {\r\n    const key = attribute\r\n    if (!this.modifiers.has(key)) {\r\n      this.modifiers.set(key, [])\r\n    }\r\n\r\n    const stack = this.modifiers.get(key)!\r\n    stack.push({\r\n      buffInstanceId,\r\n      attribute,\r\n      value,\r\n      type\r\n    })\r\n  }\r\n\r\n  public removeModifier(buffInstanceId: string): void {\r\n    for (const [key, stack] of this.modifiers.entries()) {\r\n      const filtered = stack.filter(\r\n        (modifier) => modifier.buffInstanceId !== buffInstanceId\r\n      )\r\n      if (filtered.length === 0) {\r\n        this.modifiers.delete(key)\r\n      } else {\r\n        this.modifiers.set(key, filtered)\r\n      }\r\n    }\r\n  }\r\n\r\n  public calculate(attribute: AttributeType, baseValue: number): number {\r\n    const modifiers = this.modifiers.get(attribute)\r\n    if (!modifiers || modifiers.length === 0) {\r\n      return baseValue\r\n    }\r\n\r\n    let result = baseValue\r\n    let additiveSum = 0\r\n    let multiplicativeSum = 1\r\n\r\n    for (const modifier of modifiers) {\r\n      switch (modifier.type) {\r\n        case 'ADDITIVE':\r\n          additiveSum += modifier.value\r\n          break\r\n        case 'MULTIPLICATIVE':\r\n          multiplicativeSum *= (1 + modifier.value)\r\n          break\r\n        case 'PERCENTAGE':\r\n          additiveSum += baseValue * modifier.value\r\n          break\r\n        default:\r\n          break\r\n      }\r\n    }\r\n\r\n    result += additiveSum\r\n    result *= multiplicativeSum\r\n\r\n    return result\r\n  }\r\n\r\n  public getModifiers(attribute?: AttributeType): Modifier[] {\r\n    if (attribute) {\r\n      return this.modifiers.get(attribute) || []\r\n    }\r\n\r\n    const allModifiers: Modifier[] = []\r\n    for (const stack of this.modifiers.values()) {\r\n      allModifiers.push(...stack)\r\n    }\r\n    return allModifiers\r\n  }\r\n\r\n  public clear(): void {\r\n    this.modifiers.clear()\r\n  }\r\n\r\n  public getModifierCount(): number {\r\n    let count = 0\r\n    for (const stack of this.modifiers.values()) {\r\n      count += stack.length\r\n    }\r\n    return count\r\n  }\r\n}","import { logger } from '@/utils/logger'\r\n\r\nexport class BuffErrorBoundary {\r\n  public static wrap<T>(fn: () => T): T | null {\r\n    try {\r\n      return fn()\r\n    } catch (error) {\r\n      BuffErrorBoundary.handleError(error)\r\n      return null\r\n    }\r\n  }\r\n\r\n  public static wrapAsync<T>(fn: () => Promise<T>): Promise<T | null> {\r\n    return fn().catch((error) => {\r\n      BuffErrorBoundary.handleError(error)\r\n      return null\r\n    })\r\n  }\r\n\r\n  private static handleError(error: unknown): void {\r\n    if (error instanceof Error) {\r\n      logger.error('Buff script error:', {\r\n        message: error.message,\r\n        stack: error.stack\r\n      })\r\n    } else {\r\n      logger.error('Unknown buff script error:', error)\r\n    }\r\n  }\r\n\r\n  public static executeWithRetry<T>(\r\n    fn: () => T,\r\n    maxRetries: number = 3\r\n  ): T | null {\r\n    let retries = 0\r\n\r\n    while (retries < maxRetries) {\r\n      try {\r\n        return fn()\r\n      } catch (error) {\r\n        retries++\r\n        if (retries >= maxRetries) {\r\n          BuffErrorBoundary.handleError(error)\r\n          return null\r\n        }\r\n        logger.warn(`Retrying buff script execution (${retries}/${maxRetries})`)\r\n      }\r\n    }\r\n\r\n    return null\r\n  }\r\n}","import { reactive } from 'vue'\r\nimport type { BuffConfig, BuffInstance } from '@/types/buff'\r\nimport { BuffScriptRegistry } from './BuffScriptRegistry'\r\nimport { BuffContext } from './BuffContext'\r\nimport { ModifierStack } from './ModifierStack'\r\nimport { BuffErrorBoundary } from './BuffErrorBoundary'\r\n\r\nexport class BuffSystem {\r\n  private static instance: BuffSystem\r\n  private buffInstances = reactive<Map<string, BuffInstance>>(\r\n    new Map()\r\n  )\r\n  private modifierStacks = reactive<Map<string, ModifierStack>>(\r\n    new Map()\r\n  )\r\n\r\n  private constructor() {}\r\n\r\n  public static getInstance(): BuffSystem {\r\n    if (!BuffSystem.instance) {\r\n      BuffSystem.instance = new BuffSystem()\r\n    }\r\n    return BuffSystem.instance\r\n  }\r\n\r\n  public addBuff(\r\n    characterId: string,\r\n    buffId: string,\r\n    config: BuffConfig\r\n  ): string {\r\n    const script = BuffScriptRegistry.getInstance().get(buffId)\r\n    if (!script) {\r\n      throw new Error(`Buff script ${buffId} not found`)\r\n    }\r\n\r\n    const instanceId = `${characterId}_${buffId}_${Date.now()}`\r\n    const context = new BuffContext(characterId, instanceId, config)\r\n    \r\n    const buffInstance: BuffInstance = {\r\n      id: instanceId,\r\n      characterId,\r\n      buffId,\r\n      script,\r\n      context,\r\n      startTime: Date.now(),\r\n      duration: config.duration || -1,\r\n      isActive: true\r\n    }\r\n\r\n    this.buffInstances.set(instanceId, buffInstance)\r\n    \r\n    if (!this.modifierStacks.has(characterId)) {\r\n      this.modifierStacks.set(characterId, new ModifierStack())\r\n    }\r\n\r\n    BuffErrorBoundary.wrap(() => {\r\n      script.onApply(context)\r\n    })\r\n\r\n    return instanceId\r\n  }\r\n\r\n  public removeBuff(instanceId: string): boolean {\r\n    const instance = this.buffInstances.get(instanceId)\r\n    if (!instance || !instance.isActive) {\r\n      return false\r\n    }\r\n\r\n    BuffErrorBoundary.wrap(() => {\r\n      instance.script.onRemove(instance.context)\r\n    })\r\n\r\n    instance.isActive = false\r\n    this.buffInstances.delete(instanceId)\r\n\r\n    return true\r\n  }\r\n\r\n  public refreshBuff(instanceId: string): boolean {\r\n    const instance = this.buffInstances.get(instanceId)\r\n    if (!instance || !instance.isActive) {\r\n      return false\r\n    }\r\n\r\n    BuffErrorBoundary.wrap(() => {\r\n      instance.script.onRefresh(instance.context)\r\n    })\r\n\r\n    instance.startTime = Date.now()\r\n    return true\r\n  }\r\n\r\n  public update(deltaTime: number): void {\r\n    const toRemove: string[] = []\r\n\r\n    this.buffInstances.forEach((instance) => {\r\n      if (!instance.isActive) return\r\n\r\n      BuffErrorBoundary.wrap(() => {\r\n        instance.script.onUpdate(instance.context, deltaTime)\r\n      })\r\n\r\n      if (instance.duration > 0 && Date.now() - instance.startTime >= instance.duration) {\r\n        toRemove.push(instance.id)\r\n      }\r\n    })\r\n\r\n    toRemove.forEach((instanceId) => this.removeBuff(instanceId))\r\n  }\r\n\r\n  public getBuffInstances(characterId: string): BuffInstance[] {\r\n    const instances: BuffInstance[] = []\r\n    this.buffInstances.forEach((instance) => {\r\n      if (instance.characterId === characterId && instance.isActive) {\r\n        instances.push(instance)\r\n      }\r\n    })\r\n    return instances\r\n  }\r\n\r\n  public getModifierStack(characterId: string): ModifierStack {\r\n    if (!this.modifierStacks.has(characterId)) {\r\n      this.modifierStacks.set(characterId, new ModifierStack())\r\n    }\r\n    return this.modifierStacks.get(characterId) as ModifierStack  \r\n  }\r\n\r\n  public clearAllBuffs(characterId: string): void {\r\n    const toRemove: string[] = []\r\n    this.buffInstances.forEach((instance) => {\r\n      if (instance.characterId === characterId) {\r\n        toRemove.push(instance.id)\r\n      }\r\n    })\r\n    toRemove.forEach((instanceId) => this.removeBuff(instanceId))\r\n    this.modifierStacks.delete(characterId)\r\n  }\r\n}","import { BuffScriptRegistry } from './BuffScriptRegistry'\r\n\r\nexport class BuffScriptLoader {\r\n  private static instance: BuffScriptLoader\r\n  private loadedScripts = new Set<string>()\r\n\r\n  private constructor() {}\r\n\r\n  public static getInstance(): BuffScriptLoader {\r\n    if (!BuffScriptLoader.instance) {\r\n      BuffScriptLoader.instance = new BuffScriptLoader()\r\n    }\r\n    return BuffScriptLoader.instance\r\n  }\r\n\r\n  public async loadScripts(): Promise<void> {\r\n    try {\r\n      // 手动导入已知的脚本\r\n      // 注意：在实际项目中，这里可以使用 Vite 的 glob 导入\r\n      // 但为了类型安全，我们暂时使用手动导入\r\n      const { MountainGodBuff } = await import('@/scripts/combat/MountainGodBuff')\r\n      const { PoisonDebuff } = await import('@/scripts/combat/PoisonDebuff')\r\n      const { BerserkBuff } = await import('@/scripts/combat/BerserkBuff')\r\n      const { HealOverTime } = await import('@/scripts/support/HealOverTime')\r\n      const { ShieldBuff } = await import('@/scripts/support/ShieldBuff')\r\n\r\n      // 注册脚本\r\n      const registry = BuffScriptRegistry.getInstance()\r\n      \r\n      if (MountainGodBuff.BUFF_ID) {\r\n        registry.register(MountainGodBuff.BUFF_ID, () => new MountainGodBuff(), { \r\n          filePath: '@/scripts/combat/MountainGodBuff'\r\n        })\r\n        this.loadedScripts.add('MountainGodBuff')\r\n      }\r\n      \r\n      if (PoisonDebuff.BUFF_ID) {\r\n        registry.register(PoisonDebuff.BUFF_ID, () => new PoisonDebuff(), { \r\n          filePath: '@/scripts/combat/PoisonDebuff'\r\n        })\r\n        this.loadedScripts.add('PoisonDebuff')\r\n      }\r\n      \r\n      if (BerserkBuff.BUFF_ID) {\r\n        registry.register(BerserkBuff.BUFF_ID, () => new BerserkBuff(), { \r\n          filePath: '@/scripts/combat/BerserkBuff'\r\n        })\r\n        this.loadedScripts.add('BerserkBuff')\r\n      }\r\n      \r\n      if (HealOverTime.BUFF_ID) {\r\n        registry.register(HealOverTime.BUFF_ID, () => new HealOverTime(), { \r\n          filePath: '@/scripts/support/HealOverTime'\r\n        })\r\n        this.loadedScripts.add('HealOverTime')\r\n      }\r\n      \r\n      if (ShieldBuff.BUFF_ID) {\r\n        registry.register(ShieldBuff.BUFF_ID, () => new ShieldBuff(), { \r\n          filePath: '@/scripts/support/ShieldBuff'\r\n        })\r\n        this.loadedScripts.add('ShieldBuff')\r\n      }\r\n    } catch (error) {\r\n      console.error('Failed to load buff scripts:', error)\r\n    }\r\n  }\r\n\r\n  public async reloadScripts(): Promise<void> {\r\n    // 清空已加载的脚本\r\n    this.loadedScripts.clear()\r\n    // 使用批量卸载而不是清空整个注册表\r\n    const registry = BuffScriptRegistry.getInstance()\r\n    const scriptIds = registry.list()\r\n    scriptIds.forEach(id => registry.unregister(id))\r\n    await this.loadScripts()\r\n  }\r\n\r\n  public getLoadedScriptCount(): number {\r\n    return this.loadedScripts.size\r\n  }\r\n\r\n  public clear(): void {\r\n    this.loadedScripts.clear()\r\n    // 使用批量卸载而不是清空整个注册表\r\n    const registry = BuffScriptRegistry.getInstance()\r\n    const scriptIds = registry.list()\r\n    scriptIds.forEach(id => registry.unregister(id))\r\n  }\r\n}","import type {\n  BattleParticipant,\n  BattleAction,\n  BattleState,\n} from '@/types/battle'\nimport { logger } from '@/utils/logger'\n\n// 战斗AI接口\nexport interface BattleAI {\n  /**\n   * 做出战斗决策\n   */\n  makeDecision(\n    battleState: BattleState,\n    participant: BattleParticipant,\n  ): BattleAction\n\n  /**\n   * 选择目标\n   */\n  selectTarget(battleState: BattleState, participant: BattleParticipant): string\n\n  /**\n   * 检查是否应该使用技能\n   */\n  shouldUseSkill(participant: BattleParticipant): boolean\n\n  /**\n   * 选择技能\n   */\n  selectSkill(participant: BattleParticipant): string | null\n\n  /**\n   * 选择攻击\n   */\n  selectAttack(participant: BattleParticipant): BattleAction\n}\n\n// 技能类型\nexport enum SkillType {\n  PASSIVE = 'passive',\n  SMALL = 'small',\n  ULTIMATE = 'ultimate',\n}\n\n// 技能定义\nexport interface Skill {\n  id: string\n  name: string\n  type: SkillType\n  energyCost: number\n  cooldown: number\n  lastUsed: number\n  description: string\n  damage?: number\n  heal?: number\n  buffId?: string\n}\n\n// 战场分析结果\ninterface BattleAnalysis {\n  allies: BattleParticipant[]\n  enemies: BattleParticipant[]\n  teamHealthPercent: number\n  highestThreatEnemy: { enemy: BattleParticipant | null; threat: number }\n  needsHealing: boolean\n  shouldUseSkill: boolean\n}\n\n// 基础AI策略\nexport class BaseBattleAI implements BattleAI {\n  protected skills: Map<string, Skill> = new Map()\n\n  constructor() {\n    this.initializeSkills()\n  }\n\n  protected initializeSkills(): void {\n    // 子类实现\n  }\n\n  public makeDecision(\n    battleState: BattleState,\n    participant: BattleParticipant,\n  ): BattleAction {\n    try {\n      // 验证参数\n      if (!battleState || !participant) {\n        logger.error('AI决策参数无效:', { battleState, participant })\n        return this.selectAttack(participant)\n      }\n\n      // 分析战场态势\n      const battleAnalysis = this.analyzeBattleState(battleState, participant)\n\n      // 基于战场分析做出决策\n      if (battleAnalysis.shouldUseSkill) {\n        const skillId = this.selectSkill(participant, battleAnalysis)\n        if (skillId) {\n          try {\n            return this.createSkillAction(battleState, participant, skillId)\n          } catch (skillError) {\n            logger.error('技能执行出错:', skillError)\n            return this.selectAttack(participant)\n          }\n        }\n      }\n\n      // 默认使用攻击\n      return this.selectAttack(participant)\n    } catch (error) {\n      logger.error('AI决策出错:', error)\n      try {\n        return this.selectAttack(participant)\n      } catch (attackError) {\n        logger.error('攻击执行出错:', attackError)\n        // 返回一个安全的默认行动\n        return {\n          id: `fallback_${Date.now()}`,\n          type: 'attack',\n          sourceId: participant?.id || 'unknown',\n          targetId: 'unknown',\n          damage: 10,\n          success: true,\n          timestamp: Date.now(),\n          effects: [\n            {\n              type: 'damage',\n              value: 10,\n              description: '默认攻击',\n            },\n          ],\n        }\n      }\n    }\n  }\n\n  /**\n   * 分析战场态势\n   */\n  protected analyzeBattleState(\n    battleState: BattleState,\n    participant: BattleParticipant,\n  ): BattleAnalysis {\n    const allies = Array.from(battleState.participants.values()).filter(\n      (p) => p.type === participant.type && p.isAlive(),\n    )\n\n    const enemies = Array.from(battleState.participants.values()).filter(\n      (p) => p.type !== participant.type && p.isAlive(),\n    )\n\n    // 计算团队血量\n    const teamHealth = allies.reduce((sum, p) => sum + p.currentHealth, 0)\n    const teamMaxHealth = allies.reduce((sum, p) => sum + p.maxHealth, 0)\n    const teamHealthPercent = teamMaxHealth > 0 ? teamHealth / teamMaxHealth : 0\n\n    // 计算敌人威胁\n    const highestThreatEnemy = enemies.reduce<{\n      enemy: BattleParticipant | null\n      threat: number\n    }>(\n      (max, enemy) => {\n        const threat = this.calculateThreat(enemy, participant, battleState)\n        return threat > max.threat ? { enemy, threat } : max\n      },\n      { enemy: null, threat: 0 },\n    )\n\n    // 检查是否有需要治疗的队友\n    const needsHealing = allies.some((p) => p.currentHealth / p.maxHealth < 0.3)\n\n    return {\n      allies,\n      enemies,\n      teamHealthPercent,\n      highestThreatEnemy,\n      needsHealing,\n      shouldUseSkill: this.shouldUseSkill(participant),\n    }\n  }\n\n  public selectTarget(\n    battleState: BattleState,\n    _participant: BattleParticipant,\n  ): string {\n    const enemies = Array.from(battleState.participants.values())\n      .filter((p) => p.type !== _participant.type && p.isAlive())\n      .map((p) => p)\n\n    if (enemies.length === 0) {\n      throw new Error('No valid targets')\n    }\n\n    // 基于威胁值排序选择目标\n    const targetsWithThreat = enemies.map((target) => ({\n      target,\n      threat: this.calculateThreat(target, _participant, battleState),\n    }))\n\n    // 按威胁值排序\n    targetsWithThreat.sort((a, b) => b.threat - a.threat)\n\n    return targetsWithThreat[0].target.id\n  }\n\n  /**\n   * 计算目标的威胁值\n   */\n  protected calculateThreat(\n    target: BattleParticipant,\n    participant: BattleParticipant,\n    _battleState: BattleState,\n  ): number {\n    let threat = 0\n\n    // 基于血量\n    const healthPercent = target.currentHealth / target.maxHealth\n    threat += (1 - healthPercent) * 50 // 血量越低威胁越高\n\n    // 基于能量\n    const energyPercent = target.currentEnergy / target.maxEnergy\n    threat += energyPercent * 30 // 能量越高威胁越高\n\n    // 基于类型\n    if (target.type === 'character' && participant.type === 'enemy') {\n      threat += 20 // 敌人优先攻击角色\n    }\n\n    // 基于状态效果\n    if (target.buffs.length > 0) {\n      threat += target.buffs.length * 10 // 有buff的目标威胁更高\n    }\n\n    return threat\n  }\n\n  public shouldUseSkill(participant: BattleParticipant): boolean {\n    // 检查能量是否足够\n    const energy =\n      participant.getAttribute('energy') || participant.currentEnergy || 0\n    const maxEnergy =\n      participant.getAttribute('max_energy') || participant.maxEnergy || 150\n\n    // 能量达到70%以上考虑使用技能\n    return energy >= maxEnergy * 0.7\n  }\n\n  public selectSkill(\n    _participant: BattleParticipant,\n    analysis?: BattleAnalysis,\n  ): string | null {\n    // 简单的技能选择逻辑\n    const skills = Array.from(this.skills.values())\n    if (skills.length === 0) {\n      return null\n    }\n\n    // 基于战场分析的技能选择\n    if (analysis) {\n      // 优先选择治疗技能如果团队需要治疗\n      if (analysis.needsHealing) {\n        const healSkill = skills.find((s) => s.heal && s.heal > 0)\n        if (healSkill) {\n          return healSkill.id\n        }\n      }\n\n      // 如果敌人威胁很高，优先选择高伤害技能\n      if (analysis.highestThreatEnemy.threat > 50) {\n        const damageSkill = skills.find((s) => s.damage && s.damage > 0)\n        if (damageSkill) {\n          return damageSkill.id\n        }\n      }\n    }\n\n    // 优先选择小技能\n    const smallSkill = skills.find((s) => s.type === SkillType.SMALL)\n    if (smallSkill) {\n      return smallSkill.id\n    }\n\n    // 其次选择大招\n    const ultimateSkill = skills.find((s) => s.type === SkillType.ULTIMATE)\n    if (ultimateSkill) {\n      return ultimateSkill.id\n    }\n\n    return null\n  }\n\n  public selectAttack(participant: BattleParticipant): BattleAction {\n    return {\n      id: `attack_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n      type: 'attack',\n      sourceId: participant.id,\n      targetId: '', // 会在makeDecision中设置\n      damage: Math.floor(Math.random() * 20) + 10,\n      success: true,\n      timestamp: Date.now(),\n      effects: [\n        {\n          type: 'damage',\n          value: Math.floor(Math.random() * 20) + 10,\n          description: `${participant.name} 普通攻击`,\n        },\n      ],\n    }\n  }\n\n  /**\n   * 选择治疗目标\n   */\n  protected selectHealTarget(\n    battleState: BattleState,\n    participant: BattleParticipant,\n  ): string {\n    // 收集所有友方目标\n    const allies: { target: BattleParticipant; healthPercent: number }[] = []\n\n    battleState.participants.forEach((target) => {\n      // 只选择同类型的目标（角色选择角色，敌人选择敌人）\n      if (target.type === participant.type && target.isAlive()) {\n        const healthPercent = target.currentHealth / target.maxHealth\n        allies.push({ target, healthPercent })\n      }\n    })\n\n    // 按血量百分比排序，优先选择血量低的目标\n    allies.sort((a, b) => a.healthPercent - b.healthPercent)\n\n    // 返回血量最低的友方目标\n    return allies.length > 0 ? allies[0].target.id : participant.id\n  }\n\n  protected createSkillAction(\n    battleState: BattleState,\n    participant: BattleParticipant,\n    skillId: string,\n  ): BattleAction {\n    const skill = this.skills.get(skillId)\n\n    if (!skill) {\n      throw new Error(`Skill not found: ${skillId}`)\n    }\n\n    // 根据技能类型选择目标\n    let targetId = ''\n    if (skill.heal) {\n      // 治疗技能选择友方目标\n      targetId = this.selectHealTarget(battleState, participant)\n    } else {\n      // 其他技能选择敌方目标\n      targetId = this.selectTarget(battleState, participant)\n    }\n\n    const action: BattleAction = {\n      id: `skill_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n      type: 'skill',\n      sourceId: participant.id,\n      targetId,\n      skillId,\n      success: true,\n      timestamp: Date.now(),\n      effects: [\n        {\n          type: 'status',\n          description: `${participant.name} 使用 ${skill.name}`,\n        },\n      ],\n    }\n\n    // 添加技能效果\n    if (skill.damage) {\n      action.damage = skill.damage\n      action.effects.push({\n        type: 'damage',\n        value: skill.damage,\n        description: `造成 ${skill.damage} 伤害`,\n      })\n    }\n\n    if (skill.heal) {\n      action.heal = skill.heal\n      action.effects.push({\n        type: 'heal',\n        value: skill.heal,\n        description: `恢复 ${skill.heal} 生命值`,\n      })\n    }\n\n    if (skill.buffId) {\n      action.buffId = skill.buffId\n      action.effects.push({\n        type: 'buff',\n        buffId: skill.buffId,\n        description: `施加 ${skill.name} 效果`,\n      })\n    }\n\n    return action\n  }\n\n  /**\n   * 添加技能\n   */\n  public addSkill(skill: Skill): void {\n    this.skills.set(skill.id, skill)\n  }\n\n  /**\n   * 获取技能\n   */\n  public getSkill(skillId: string): Skill | undefined {\n    return this.skills.get(skillId)\n  }\n\n  /**\n   * 获取所有技能\n   */\n  public getSkills(): Skill[] {\n    return Array.from(this.skills.values())\n  }\n}\n\n// 角色AI\nexport class CharacterAI extends BaseBattleAI {\n  protected initializeSkills(): void {\n    // 默认角色技能\n    this.addSkill({\n      id: 'skill_heal',\n      name: '治疗术',\n      type: SkillType.SMALL,\n      energyCost: 30,\n      cooldown: 2000,\n      lastUsed: 0,\n      description: '恢复生命值',\n      heal: 50,\n    })\n\n    this.addSkill({\n      id: 'skill_attack',\n      name: '强力攻击',\n      type: SkillType.SMALL,\n      energyCost: 25,\n      cooldown: 1500,\n      lastUsed: 0,\n      description: '造成额外伤害',\n      damage: 35,\n    })\n\n    this.addSkill({\n      id: 'skill_ultimate',\n      name: '终极技能',\n      type: SkillType.ULTIMATE,\n      energyCost: 100,\n      cooldown: 5000,\n      lastUsed: 0,\n      description: '造成大量伤害',\n      damage: 80,\n    })\n  }\n\n  public shouldUseSkill(participant: BattleParticipant): boolean {\n    // 角色特有逻辑\n    const healthPercent = participant.currentHealth / participant.maxHealth\n\n    // 血量低于50%时优先治疗\n    if (healthPercent < 0.5) {\n      return true\n    }\n\n    return super.shouldUseSkill(participant)\n  }\n\n  public selectSkill(\n    participant: BattleParticipant,\n    analysis?: BattleAnalysis,\n  ): string | null {\n    const healthPercent = participant.currentHealth / participant.maxHealth\n\n    // 血量低时优先使用治疗技能\n    if (healthPercent < 0.5) {\n      const healSkill = Array.from(this.skills.values()).find(\n        (s) => s.heal && s.heal > 0,\n      )\n      if (healSkill) {\n        return healSkill.id\n      }\n    }\n\n    // 满血时不使用治疗技能\n    const healSkill = Array.from(this.skills.values()).find(\n      (s) => s.heal && s.heal > 0,\n    )\n    if (healSkill && healthPercent >= 1) {\n      // 满血，跳过治疗技能，选择其他技能\n      const attackSkills = Array.from(this.skills.values()).filter(\n        (s) => s.damage && s.damage > 0,\n      )\n      if (attackSkills.length > 0) {\n        // 优先选择伤害最高的技能\n        attackSkills.sort((a, b) => (b.damage || 0) - (a.damage || 0))\n        return attackSkills[0].id\n      }\n    }\n\n    // 能量足够时优先使用大招\n    if (participant.currentEnergy >= 100) {\n      const ultimateSkill = Array.from(this.skills.values()).find(\n        (s) => s.type === SkillType.ULTIMATE,\n      )\n      if (ultimateSkill) {\n        return ultimateSkill.id\n      }\n    }\n\n    return super.selectSkill(participant, analysis)\n  }\n\n  public selectTarget(\n    battleState: BattleState,\n    _participant: BattleParticipant,\n  ): string {\n    const enemies = Array.from(battleState.participants.values())\n      .filter((p) => p.type === 'enemy' && p.isAlive())\n      .map((p) => p)\n\n    if (enemies.length === 0) {\n      throw new Error('No enemies found')\n    }\n\n    // 优先攻击血量最低的敌人\n    enemies.sort((a, b) => a.currentHealth - b.currentHealth)\n    return enemies[0].id\n  }\n}\n\n// 敌人AI\nexport class EnemyAI extends BaseBattleAI {\n  protected initializeSkills(): void {\n    // 默认敌人技能\n    this.addSkill({\n      id: 'enemy_skill_1',\n      name: '爪击',\n      type: SkillType.SMALL,\n      energyCost: 20,\n      cooldown: 1000,\n      lastUsed: 0,\n      description: '快速攻击',\n      damage: 25,\n    })\n\n    this.addSkill({\n      id: 'enemy_skill_2',\n      name: '狂暴',\n      type: SkillType.ULTIMATE,\n      energyCost: 80,\n      cooldown: 3000,\n      lastUsed: 0,\n      description: '增加攻击力',\n      damage: 60,\n    })\n  }\n\n  public shouldUseSkill(participant: BattleParticipant): boolean {\n    // 敌人更激进\n    return participant.currentEnergy >= 50\n  }\n\n  public selectSkill(\n    participant: BattleParticipant,\n    analysis?: BattleAnalysis,\n  ): string | null {\n    return super.selectSkill(participant, analysis)\n  }\n\n  public selectTarget(\n    battleState: BattleState,\n    _participant: BattleParticipant,\n  ): string {\n    const characters = Array.from(battleState.participants.values())\n      .filter((p) => p.type === 'character' && p.isAlive())\n      .map((p) => p)\n\n    if (characters.length === 0) {\n      throw new Error('No characters found')\n    }\n\n    // 优先攻击血量最低的角色\n    characters.sort((a, b) => a.currentHealth - b.currentHealth)\n    return characters[0].id\n  }\n}\n\n// AI工厂\nexport class BattleAIFactory {\n  public static createAI(type: 'character' | 'enemy'): BattleAI {\n    return type === 'character' ? new CharacterAI() : new EnemyAI()\n  }\n}\n","import type {\n  BattleSystem as IBattleSystem,\n  BattleState,\n  BattleAction,\n  BattleParticipant,\n  BattleEntityType,\n  BattleCharacter,\n  BattleEnemy,\n} from '@/types/battle'\nimport type { Character } from '@/types/character'\nimport type { EnemyInstance } from '@/types/enemy'\nimport type { AttributeType } from '@/types/modifier'\nimport { logger } from '@/utils/logger'\nimport { BattleAIFactory, BattleAI } from '@/core/BattleAI'\n\ninterface ParticipantInfo {\n  id: string\n  name: string\n  type: 'character' | 'enemy'\n  maxHealth: number\n  currentHealth: number\n  maxEnergy: number\n  currentEnergy: number\n}\n\ninterface BattleData {\n  battleId: string\n  participants: Map<string, BattleParticipant>\n  actions: BattleAction[]\n  turnOrder: string[]\n  currentTurn: number\n  isActive: boolean\n  startTime: number\n  endTime?: number\n  winner?: BattleEntityType\n  aiInstances: Map<string, BattleAI> // 每个参与者的AI实例\n}\n\nabstract class BaseBattleParticipant {\n  id: string\n  name: string\n  level: number\n  currentHealth: number\n  maxHealth: number\n  currentEnergy: number\n  maxEnergy: number\n  buffs: string[]\n  skills: Map<string, any> = new Map()\n\n  constructor(data: {\n    id: string\n    name: string\n    level: number\n    currentHealth: number\n    maxHealth: number\n    currentEnergy?: number\n    maxEnergy?: number\n    buffs?: string[]\n    skills?: any[]\n  }) {\n    this.id = data.id\n    this.name = data.name\n    this.level = data.level\n    this.currentHealth = data.currentHealth\n    this.maxHealth = data.maxHealth\n    this.currentEnergy = data.currentEnergy || 0\n    this.maxEnergy = data.maxEnergy || 150\n    this.buffs = data.buffs || []\n\n    // 初始化技能\n    if (data.skills) {\n      data.skills.forEach((skill) => {\n        this.skills.set(skill.id, skill)\n      })\n    }\n  }\n\n  abstract get type(): BattleEntityType\n\n  getAttribute(attribute: string): number {\n    // Simplified attribute system - in real implementation, this would use the actual attribute system\n    switch (attribute) {\n      case 'HP':\n        return this.currentHealth\n      case 'MAX_HP':\n        return this.maxHealth\n      case 'ATK':\n        return this.level * 5 // Simplified attack calculation\n      case 'DEF':\n        return this.level * 2 // Simplified defense calculation\n      case 'energy':\n        return this.currentEnergy\n      case 'max_energy':\n        return this.maxEnergy\n      default:\n        return 0\n    }\n  }\n\n  setAttribute(attribute: string, value: number): void {\n    if (attribute === 'HP') {\n      this.currentHealth = Math.max(0, Math.min(value, this.maxHealth))\n    } else if (attribute === 'energy') {\n      this.currentEnergy = Math.max(0, Math.min(value, this.maxEnergy))\n    }\n    // Other attributes would be handled in a real implementation\n  }\n\n  addBuff(buffInstanceId: string): void {\n    if (!this.buffs.includes(buffInstanceId)) {\n      this.buffs.push(buffInstanceId)\n    }\n  }\n\n  removeBuff(buffInstanceId: string): void {\n    this.buffs = this.buffs.filter((id) => id !== buffInstanceId)\n  }\n\n  hasBuff(buffId: string): boolean {\n    return this.buffs.some((id) => id.includes(buffId))\n  }\n\n  takeDamage(amount: number): number {\n    const damage = Math.max(0, amount)\n    this.currentHealth = Math.max(0, this.currentHealth - damage)\n    // 受到攻击获得15能量\n    this.gainEnergy(15)\n    return damage\n  }\n\n  heal(amount: number): number {\n    const healAmount = Math.max(0, amount)\n    const originalHealth = this.currentHealth\n    this.currentHealth = Math.min(\n      this.currentHealth + healAmount,\n      this.maxHealth,\n    )\n    return this.currentHealth - originalHealth\n  }\n\n  gainEnergy(amount: number): void {\n    this.currentEnergy = Math.min(this.currentEnergy + amount, this.maxEnergy)\n  }\n\n  spendEnergy(amount: number): boolean {\n    if (this.currentEnergy >= amount) {\n      this.currentEnergy -= amount\n      return true\n    }\n    return false\n  }\n\n  isAlive(): boolean {\n    return this.currentHealth > 0\n  }\n\n  // 技能管理\n  addSkill(skill: any): void {\n    this.skills.set(skill.id, skill)\n  }\n\n  getSkill(skillId: string): any {\n    return this.skills.get(skillId)\n  }\n\n  getSkills(): any[] {\n    return Array.from(this.skills.values())\n  }\n\n  hasSkill(skillId: string): boolean {\n    return this.skills.has(skillId)\n  }\n\n  // 行动后处理\n  afterAction(): void {\n    // 每次行动后获得能量\n    this.gainEnergy(10)\n  }\n\n  // 检查是否满血\n  isFullHealth(): boolean {\n    return this.currentHealth >= this.maxHealth\n  }\n\n  // 检查是否需要治疗\n  needsHealing(): boolean {\n    return this.currentHealth / this.maxHealth < 0.5\n  }\n}\n\nclass SimpleBattleCharacter\n  extends BaseBattleParticipant\n  implements BattleCharacter\n{\n  type = 'character' as const\n  character: Character\n\n  constructor(data: {\n    id: string\n    name: string\n    level: number\n    currentHealth: number\n    maxHealth: number\n    buffs?: string[]\n    character?: Character\n  }) {\n    super(data)\n    this.character = data.character || this.createDefaultCharacter(data)\n  }\n\n  private createDefaultCharacter(data: {\n    id: string\n    name: string\n    level: number\n  }): Character {\n    const attributes: Record<AttributeType, number> = {\n      HP: data.level * 10,\n      MP: data.level * 5,\n      ATK: data.level * 2,\n      DEF: data.level,\n      SPD: data.level,\n      CRIT_RATE: 0.05,\n      CRIT_DMG: 1.5,\n      ACCURACY: 0.9,\n      EVADE: 0.1,\n      LIFESTEAL: 0,\n      REGENERATION: 0,\n      MANA_REGEN: 0,\n      DAMAGE_BOOST: 0,\n      DAMAGE_REDUCE: 0,\n    }\n\n    const buffs: string[] = []\n\n    return {\n      id: data.id,\n      name: data.name,\n      level: data.level,\n      attributes,\n      buffs,\n      getAttribute: (attribute: AttributeType) => attributes[attribute] || 0,\n      setAttribute: (attribute: AttributeType, value: number) => {\n        attributes[attribute] = value\n      },\n      addBuff: (buffInstanceId: string) => {\n        if (!buffs.includes(buffInstanceId)) {\n          buffs.push(buffInstanceId)\n        }\n      },\n      removeBuff: (buffInstanceId: string) => {\n        const index = buffs.indexOf(buffInstanceId)\n        if (index !== -1) {\n          buffs.splice(index, 1)\n        }\n      },\n      hasBuff: (buffId: string) => buffs.some((id) => id.includes(buffId)),\n    }\n  }\n}\n\nclass SimpleBattleEnemy extends BaseBattleParticipant implements BattleEnemy {\n  type = 'enemy' as const\n  enemy: EnemyInstance\n\n  constructor(data: {\n    id: string\n    name: string\n    level: number\n    currentHealth: number\n    maxHealth: number\n    buffs?: string[]\n    enemy?: EnemyInstance\n  }) {\n    super(data)\n    this.enemy = data.enemy || this.createDefaultEnemy(data)\n  }\n\n  private createDefaultEnemy(data: {\n    id: string\n    name: string\n    level: number\n    currentHealth: number\n    maxHealth: number\n  }): EnemyInstance {\n    const stats = {\n      health: data.maxHealth,\n      minAttack: data.level * 2,\n      maxAttack: data.level * 4,\n      defense: data.level,\n      speed: data.level * 2,\n    }\n\n    const buffs: string[] = []\n    const activeSkills = new Set<string>()\n    let enemyCurrentHealth = data.currentHealth\n    const enemyMaxHealth = data.maxHealth\n\n    return {\n      id: data.id,\n      name: data.name,\n      level: data.level,\n      stats,\n      drops: [],\n      skills: {},\n      get currentHealth() {\n        return enemyCurrentHealth\n      },\n      set currentHealth(value: number) {\n        enemyCurrentHealth = Math.max(0, Math.min(value, enemyMaxHealth))\n      },\n      buffs,\n      activeSkills,\n      lastActionTime: Date.now(),\n      get isDefeated() {\n        return enemyCurrentHealth <= 0\n      },\n      getAttribute: (attribute: string) => {\n        switch (attribute) {\n          case 'HP':\n            return enemyCurrentHealth\n          case 'MAX_HP':\n            return enemyMaxHealth\n          case 'ATK':\n            return stats.minAttack + (stats.maxAttack - stats.minAttack) / 2\n          case 'DEF':\n            return stats.defense\n          case 'SPD':\n            return stats.speed\n          default:\n            return 0\n        }\n      },\n      setAttribute: (attribute: string, value: number) => {\n        if (attribute === 'HP') {\n          enemyCurrentHealth = Math.max(0, Math.min(value, enemyMaxHealth))\n        }\n      },\n      addBuff: (buffInstanceId: string) => {\n        if (!buffs.includes(buffInstanceId)) {\n          buffs.push(buffInstanceId)\n        }\n      },\n      removeBuff: (buffInstanceId: string) => {\n        const index = buffs.indexOf(buffInstanceId)\n        if (index !== -1) {\n          buffs.splice(index, 1)\n        }\n      },\n      hasBuff: (buffId: string) => buffs.some((id) => id.includes(buffId)),\n    }\n  }\n}\n\nexport class GameBattleSystem implements IBattleSystem {\n  private static instance: GameBattleSystem\n  private battles = new Map<string, BattleData>()\n  private battleLogger = logger\n\n  private constructor() {}\n\n  public static getInstance(): GameBattleSystem {\n    if (!GameBattleSystem.instance) {\n      GameBattleSystem.instance = new GameBattleSystem()\n    }\n    return GameBattleSystem.instance\n  }\n\n  public createBattle(participantsInfo: ParticipantInfo[]): BattleState {\n    const battleId = `battle_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`\n\n    const participants = new Map<string, BattleParticipant>()\n    const turnOrder: string[] = []\n\n    // Create participants based on provided info\n    participantsInfo.forEach((info) => {\n      if (info.type === 'character') {\n        const participant = new SimpleBattleCharacter({\n          id: `character_${info.id}`,\n          name: info.name,\n          level: 5,\n          currentHealth: info.currentHealth,\n          maxHealth: info.maxHealth,\n          buffs: [],\n        })\n        participant.currentEnergy = info.currentEnergy\n        participant.maxEnergy = info.maxEnergy\n        participants.set(participant.id, participant)\n        turnOrder.push(participant.id)\n      } else if (info.type === 'enemy') {\n        const participant = new SimpleBattleEnemy({\n          id: `enemy_${info.id}`,\n          name: info.name,\n          level: 5,\n          currentHealth: info.currentHealth,\n          maxHealth: info.maxHealth,\n          buffs: [],\n        })\n        participant.currentEnergy = info.currentEnergy\n        participant.maxEnergy = info.maxEnergy\n        participants.set(participant.id, participant)\n        turnOrder.push(participant.id)\n      }\n    })\n\n    // Simple turn order based on speed (in real implementation, would use actual speed attribute)\n    turnOrder.sort(() => Math.random() - 0.5)\n\n    const aiInstances = new Map<string, BattleAI>()\n\n    // 为每个参与者创建AI实例\n    participants.forEach((participant) => {\n      const ai = BattleAIFactory.createAI(participant.type)\n      aiInstances.set(participant.id, ai)\n    })\n\n    const battleData: BattleData = {\n      battleId,\n      participants,\n      actions: [],\n      turnOrder,\n      currentTurn: 0,\n      isActive: true,\n      startTime: Date.now(),\n      winner: undefined,\n      aiInstances,\n    }\n\n    this.battles.set(battleId, battleData)\n    this.battleLogger.info(`Battle created: ${battleId}`, {\n      participantCount: participantsInfo.length,\n      characterCount: participantsInfo.filter((p) => p.type === 'character')\n        .length,\n      enemyCount: participantsInfo.filter((p) => p.type === 'enemy').length,\n    })\n\n    // Log initial battle state\n    this.addBattleAction(battleId, {\n      id: `init_${Date.now()}`,\n      type: 'attack',\n      sourceId: 'system',\n      targetId: 'system',\n      damage: 0,\n      heal: 0,\n      success: true,\n      timestamp: Date.now(),\n      effects: [\n        {\n          type: 'status',\n          description: `战斗开始！参战角色: ${participantsInfo.filter((p) => p.type === 'character').length} 人，参战敌人: ${participantsInfo.filter((p) => p.type === 'enemy').length} 人`,\n          duration: 0,\n        },\n      ],\n    })\n\n    return this.convertToBattleState(battleData)\n  }\n\n  public async processTurn(battleId: string): Promise<void> {\n    const battle = this.battles.get(battleId)\n    if (!battle || !battle.isActive) {\n      return\n    }\n\n    // 每回合开始时，所有存活的参与者获得25能量\n    battle.participants.forEach((participant) => {\n      if (participant.isAlive()) {\n        participant.gainEnergy(25)\n      }\n    })\n\n    if (battle.currentTurn >= battle.turnOrder.length) {\n      battle.currentTurn = 0\n    }\n\n    const currentParticipantId = battle.turnOrder[battle.currentTurn]\n    const participant = battle.participants.get(currentParticipantId)\n\n    if (!participant || !participant.isAlive()) {\n      battle.currentTurn++\n      return\n    }\n\n    try {\n      // 获取参与者的AI实例\n      const ai = battle.aiInstances.get(participant.id)\n      if (!ai) {\n        // 如果没有AI实例，使用默认AI\n        const defaultAi = BattleAIFactory.createAI(participant.type)\n        battle.aiInstances.set(participant.id, defaultAi)\n        await this.executeDefaultAction(battle, participant)\n      } else {\n        // 使用AI做出决策\n        const battleState = this.convertToBattleState(battle)\n        const action = ai.makeDecision(battleState, participant)\n        // 设置action的回合号\n        action.turn = battle.currentTurn + 1\n\n        // 确保目标有效\n        const target = battle.participants.get(action.targetId)\n        if (target && target.isAlive()) {\n          await this.executeAction(action)\n        } else {\n          // 目标无效，使用默认行动\n          await this.executeDefaultAction(battle, participant)\n        }\n      }\n    } catch (error) {\n      logger.error('AI决策出错:', error)\n      // 出错时使用默认行动\n      await this.executeDefaultAction(battle, participant)\n    }\n\n    battle.currentTurn++\n\n    // Check for battle end condition\n    const aliveCharacters = Array.from(battle.participants.values()).filter(\n      (p) => p.type === 'character' && p.isAlive(),\n    )\n    const aliveEnemies = Array.from(battle.participants.values()).filter(\n      (p) => p.type === 'enemy' && p.isAlive(),\n    )\n\n    if (aliveCharacters.length === 0) {\n      this.endBattle(battle.battleId, 'enemy')\n    } else if (aliveEnemies.length === 0) {\n      this.endBattle(battle.battleId, 'character')\n    }\n  }\n\n  // 执行默认行动\n  private async executeDefaultAction(\n    battle: BattleData,\n    participant: BattleParticipant,\n  ): Promise<void> {\n    const enemies = Array.from(battle.participants.values())\n      .filter((p) => p.type === 'enemy' && p.isAlive())\n      .map((p) => p.id)\n\n    const characters = Array.from(battle.participants.values())\n      .filter((p) => p.type === 'character' && p.isAlive())\n      .map((p) => p.id)\n\n    let targetId: string\n    let damage: number\n\n    if (participant.type === 'character' && enemies.length > 0) {\n      targetId = enemies[Math.floor(Math.random() * enemies.length)]\n      damage = Math.floor(Math.random() * 20) + 10\n    } else if (participant.type === 'enemy' && characters.length > 0) {\n      targetId = characters[Math.floor(Math.random() * characters.length)]\n      damage = Math.floor(Math.random() * 15) + 8\n    } else {\n      return\n    }\n\n\n    await this.executeAction({\n      id: `action_${Date.now()}`,\n      type: 'attack',\n      sourceId: participant.id,\n      targetId,\n      damage,\n      success: true,\n      timestamp: Date.now(),\n      turn: battle.currentTurn + 1,\n      effects: [\n        {\n          type: 'damage',\n          value: damage,\n          description: `${participant.name} 普通攻击 造成 ${damage} 伤害`,\n        },\n      ],\n    })\n  }\n\n  public async executeAction(action: BattleAction): Promise<BattleAction> {\n    const battle = this.findBattleByParticipant(action.sourceId)\n    if (!battle) {\n      throw new Error(\n        `No active battle found for participant ${action.sourceId}`,\n      )\n    }\n\n    const source = battle.participants.get(action.sourceId)\n    const target = battle.participants.get(action.targetId)\n\n    if (!source || !target) {\n      throw new Error(`Invalid source or target in action`)\n    }\n\n    // 处理技能执行\n    if (action.type === 'skill' && action.skillId) {\n      // 模拟技能能量消耗\n      const energyCost = this.getSkillEnergyCost(action.skillId)\n      if (energyCost > 0) {\n        const success = source.spendEnergy(energyCost)\n        if (!success) {\n          // 能量不足，改为普通攻击\n          action.type = 'attack'\n          action.damage = Math.floor(Math.random() * 20) + 10\n          action.effects = [\n            {\n              type: 'damage',\n              value: action.damage,\n              description: `${source.name} 普通攻击 (能量不足)`,\n            },\n          ]\n        } else {\n          // 能量消耗成功\n          action.effects.push({\n            type: 'status',\n            description: `消耗 ${energyCost} 能量`,\n          })\n        }\n      }\n    }\n\n    // Apply damage or heal\n    if (action.damage && action.damage > 0) {\n      const actualDamage = target.takeDamage(action.damage)\n      action.damage = actualDamage\n\n      this.battleLogger.info(`Damage dealt: ${source.name} → ${target.name}`, {\n        damage: actualDamage,\n        targetHealth: target.currentHealth,\n      })\n    }\n\n    if (action.heal && action.heal > 0) {\n      const actualHeal = target.heal(action.heal)\n      action.heal = actualHeal\n\n      this.battleLogger.info(`Heal applied: ${source.name} → ${target.name}`, {\n        heal: actualHeal,\n        targetHealth: target.currentHealth,\n      })\n    }\n\n    // Apply buff if specified\n    if (action.buffId) {\n      // In a real implementation, this would use the BuffSystem\n      const buffInstanceId = `${target.id}_${action.buffId}_${Date.now()}`\n      target.addBuff(buffInstanceId)\n\n      action.effects.push({\n        type: 'buff',\n        buffId: action.buffId,\n        description: `${action.buffId} applied to ${target.name}`,\n      })\n    }\n\n    // 行动后处理\n    source.afterAction()\n\n    // Add action to battle log\n    this.addBattleAction(battle.battleId, action)\n\n    return action\n  }\n\n  // 获取技能能量消耗\n  private getSkillEnergyCost(skillId: string): number {\n    // 实现50能量释放小技能，100能量释放大招的机制\n    if (skillId.includes('ultimate') || skillId.includes('大招')) {\n      return 100 // 大招消耗100能量\n    } else if (skillId.includes('skill') || skillId.includes('技能')) {\n      return 50 // 小技能消耗50能量\n    }\n    return 0\n  }\n\n  public getBattleState(battleId: string): BattleState | undefined {\n    const battle = this.battles.get(battleId)\n    if (!battle) return undefined\n\n    return this.convertToBattleState(battle)\n  }\n\n  public endBattle(battleId: string, winner: BattleEntityType): void {\n    const battle = this.battles.get(battleId)\n    if (!battle) return\n\n    battle.isActive = false\n    battle.winner = winner\n    battle.endTime = Date.now()\n\n    this.addBattleAction(battleId, {\n      id: `end_${Date.now()}`,\n      type: 'skill',\n      sourceId: 'system',\n      targetId: 'system',\n      success: true,\n      timestamp: Date.now(),\n      turn: battle.currentTurn + 1,\n      effects: [\n        {\n          type: 'status',\n          description: `战斗结束！胜利者: ${winner === 'character' ? '角色方' : '敌方'}`,\n          duration: 0,\n        },\n      ],\n    })\n\n    this.battleLogger.info(`Battle ended: ${battleId}`, { winner })\n  }\n\n  private addBattleAction(battleId: string, action: BattleAction): void {\n    const battle = this.battles.get(battleId)\n    if (!battle) return\n\n    battle.actions.push(action)\n\n    // Keep only last 100 actions to prevent memory issues\n    if (battle.actions.length > 100) {\n      battle.actions = battle.actions.slice(-100)\n    }\n  }\n\n  private findBattleByParticipant(\n    participantId: string,\n  ): BattleData | undefined {\n    for (const battle of this.battles.values()) {\n      if (battle.participants.has(participantId) && battle.isActive) {\n        return battle\n      }\n    }\n    return undefined\n  }\n\n  private convertToBattleState(battleData: BattleData): BattleState {\n    return {\n      battleId: battleData.battleId,\n      participants: new Map(battleData.participants),\n      actions: [...battleData.actions],\n      turnOrder: [...battleData.turnOrder],\n      currentTurn: battleData.currentTurn,\n      isActive: battleData.isActive,\n      startTime: battleData.startTime,\n      endTime: battleData.endTime,\n      winner: battleData.winner,\n    }\n  }\n\n  // Additional helper methods for UI integration\n  public getAllBattles(): BattleState[] {\n    return Array.from(this.battles.values()).map((b) =>\n      this.convertToBattleState(b),\n    )\n  }\n\n  public getActiveBattles(): BattleState[] {\n    return Array.from(this.battles.values())\n      .filter((b) => b.isActive)\n      .map((b) => this.convertToBattleState(b))\n  }\n\n  public clearCompletedBattles(): void {\n    for (const [battleId, battle] of this.battles.entries()) {\n      if (!battle.isActive) {\n        this.battles.delete(battleId)\n      }\n    }\n  }\n}\n","import { logger } from './logger'\r\n\r\ninterface PerformanceMetric {\r\n  name: string\r\n  calls: number\r\n  totalTime: number\r\n  avgTime: number\r\n  maxTime: number\r\n  minTime: number\r\n}\r\n\r\nclass PerformanceMonitor {\r\n  private metrics = new Map<string, PerformanceMetric>()\r\n  private enabled = false\r\n\r\n  public enable(): void {\r\n    this.enabled = true\r\n    logger.info('Performance monitoring enabled')\r\n  }\r\n\r\n  public disable(): void {\r\n    this.enabled = false\r\n    logger.info('Performance monitoring disabled')\r\n  }\r\n\r\n  public measure<T>(name: string, fn: () => T): T {\r\n    if (!this.enabled) {\r\n      return fn()\r\n    }\r\n\r\n    const start = performance.now()\r\n    const result = fn()\r\n    const end = performance.now()\r\n    const duration = end - start\r\n\r\n    this.recordMetric(name, duration)\r\n\r\n    return result\r\n  }\r\n\r\n  private recordMetric(name: string, duration: number): void {\r\n    if (!this.metrics.has(name)) {\r\n      this.metrics.set(name, {\r\n        name,\r\n        calls: 0,\r\n        totalTime: 0,\r\n        avgTime: 0,\r\n        maxTime: 0,\r\n        minTime: Infinity\r\n      })\r\n    }\r\n\r\n    const metric = this.metrics.get(name)!\r\n    metric.calls++\r\n    metric.totalTime += duration\r\n    metric.avgTime = metric.totalTime / metric.calls\r\n    metric.maxTime = Math.max(metric.maxTime, duration)\r\n    metric.minTime = Math.min(metric.minTime, duration)\r\n  }\r\n\r\n  public getMetrics(): PerformanceMetric[] {\r\n    return Array.from(this.metrics.values())\r\n  }\r\n\r\n  public getMetric(name: string): PerformanceMetric | undefined {\r\n    return this.metrics.get(name)\r\n  }\r\n\r\n  public reset(): void {\r\n    this.metrics.clear()\r\n    logger.info('Performance metrics reset')\r\n  }\r\n\r\n  public printReport(): void {\r\n    if (!this.enabled || this.metrics.size === 0) {\r\n      logger.info('No performance metrics to report')\r\n      return\r\n    }\r\n\r\n    logger.info('=== Performance Report ===')\r\n    this.getMetrics().forEach((metric) => {\r\n      logger.info(`${metric.name}:`, {\r\n        calls: metric.calls,\r\n        avgTime: `${metric.avgTime.toFixed(2)}ms`,\r\n        maxTime: `${metric.maxTime.toFixed(2)}ms`,\r\n        minTime: `${metric.minTime.toFixed(2)}ms`,\r\n        totalTime: `${metric.totalTime.toFixed(2)}ms`\r\n      })\r\n    })\r\n    logger.info('========================')\r\n  }\r\n}\r\n\r\nexport const perfMonitor = new PerformanceMonitor()\r\nexport const measure = (name: string, fn: () => any) => {\r\n  return perfMonitor.measure(name, fn)\r\n}\r\n","import { logger } from './logger'\r\n\r\ninterface ObjectPoolOptions<T> {\r\n  maxSize: number\r\n  create: () => T\r\n  reset: (obj: T) => void\r\n  validate?: (obj: T) => boolean\r\n}\r\n\r\nexport class ObjectPool<T> {\r\n  private pool: T[] = []\r\n  private options: ObjectPoolOptions<T>\r\n  private borrowedCount = 0\r\n\r\n  constructor(options: ObjectPoolOptions<T>) {\r\n    this.options = options\r\n  }\r\n\r\n  public borrow(): T {\r\n    if (this.pool.length > 0) {\r\n      const obj = this.pool.pop()!\r\n      if (this.options.validate && !this.options.validate(obj)) {\r\n        logger.warn('Object pool validation failed, creating new instance')\r\n        return this.options.create()\r\n      }\r\n      this.borrowedCount++\r\n      return obj\r\n    }\r\n\r\n    if (this.borrowedCount >= this.options.maxSize) {\r\n      logger.warn('Object pool max size reached, creating new instance')\r\n    }\r\n\r\n    this.borrowedCount++\r\n    return this.options.create()\r\n  }\r\n\r\n  public return(obj: T): void {\r\n    if (this.pool.length >= this.options.maxSize) {\r\n      logger.debug('Object pool full, discarding instance')\r\n      return\r\n    }\r\n\r\n    try {\r\n      this.options.reset(obj)\r\n      this.pool.push(obj)\r\n      this.borrowedCount = Math.max(0, this.borrowedCount - 1)\r\n    } catch (error) {\r\n      logger.error('Failed to reset object in pool:', error)\r\n    }\r\n  }\r\n\r\n  public getPoolSize(): number {\r\n    return this.pool.length\r\n  }\r\n\r\n  public getBorrowedCount(): number {\r\n    return this.borrowedCount\r\n  }\r\n\r\n  public clear(): void {\r\n    this.pool = []\r\n    this.borrowedCount = 0\r\n    logger.info('Object pool cleared')\r\n  }\r\n\r\n  public prewarm(count: number): void {\r\n    for (let i = 0; i < count && this.pool.length < this.options.maxSize; i++) {\r\n      this.pool.push(this.options.create())\r\n    }\r\n    logger.info(`Object pool prewarmed with ${count} instances`)\r\n  }\r\n}\r\n\r\n// 预定义的对象池实例\r\nexport const createBuffContextPool = () => {\r\n  return new ObjectPool({\r\n    maxSize: 100,\r\n    create: () => {\r\n      // 注意：这里只是占位，实际的 BuffContext 创建需要具体参数\r\n      // 实际使用时，需要在 borrow 后进行初始化\r\n      return {} as any\r\n    },\r\n    reset: (context) => {\r\n      // 重置 BuffContext 的状态\r\n      if (context.variables) {\r\n        context.variables.clear()\r\n      }\r\n    }\r\n  })\r\n}\r\n","import { logger } from './logger'\r\n\r\ninterface ValidationError {\r\n  field: string\r\n  message: string\r\n}\r\n\r\ninterface Schema {\r\n  type: string\r\n  properties?: Record<string, Schema>\r\n  required?: string[]\r\n  minLength?: number\r\n  maxLength?: number\r\n  minimum?: number\r\n  maximum?: number\r\n  enum?: any[]\r\n}\r\n\r\nexport class SchemaValidator {\r\n  public validate(data: any, schema: Schema): {\r\n    valid: boolean\r\n    errors: ValidationError[]\r\n  } {\r\n    const errors: ValidationError[] = []\r\n    this.validateValue('', data, schema, errors)\r\n    return {\r\n      valid: errors.length === 0,\r\n      errors\r\n    }\r\n  }\r\n\r\n  private validateValue(\r\n    path: string,\r\n    value: any,\r\n    schema: Schema,\r\n    errors: ValidationError[]\r\n  ): void {\r\n    // 验证类型\r\n    if (schema.type === 'string' && typeof value !== 'string') {\r\n      errors.push({\r\n        field: path || 'root',\r\n        message: 'Expected string'\r\n      })\r\n      return\r\n    }\r\n\r\n    if (schema.type === 'number' && typeof value !== 'number') {\r\n      errors.push({\r\n        field: path || 'root',\r\n        message: 'Expected number'\r\n      })\r\n      return\r\n    }\r\n\r\n    if (schema.type === 'boolean' && typeof value !== 'boolean') {\r\n      errors.push({\r\n        field: path || 'root',\r\n        message: 'Expected boolean'\r\n      })\r\n      return\r\n    }\r\n\r\n    if (schema.type === 'array' && !Array.isArray(value)) {\r\n      errors.push({\r\n        field: path || 'root',\r\n        message: 'Expected array'\r\n      })\r\n      return\r\n    }\r\n\r\n    if (schema.type === 'object' && typeof value !== 'object') {\r\n      errors.push({\r\n        field: path || 'root',\r\n        message: 'Expected object'\r\n      })\r\n      return\r\n    }\r\n\r\n    // 验证字符串长度\r\n    if (schema.type === 'string') {\r\n      if (schema.minLength !== undefined && value.length < schema.minLength) {\r\n        errors.push({\r\n          field: path || 'root',\r\n          message: `String length must be at least ${schema.minLength}`\r\n        })\r\n      }\r\n      if (schema.maxLength !== undefined && value.length > schema.maxLength) {\r\n        errors.push({\r\n          field: path || 'root',\r\n          message: `String length must be at most ${schema.maxLength}`\r\n        })\r\n      }\r\n    }\r\n\r\n    // 验证数字范围\r\n    if (schema.type === 'number') {\r\n      if (schema.minimum !== undefined && value < schema.minimum) {\r\n        errors.push({\r\n          field: path || 'root',\r\n          message: `Number must be at least ${schema.minimum}`\r\n        })\r\n      }\r\n      if (schema.maximum !== undefined && value > schema.maximum) {\r\n        errors.push({\r\n          field: path || 'root',\r\n          message: `Number must be at most ${schema.maximum}`\r\n        })\r\n      }\r\n    }\r\n\r\n    // 验证枚举值\r\n    if (schema.enum !== undefined && !schema.enum.includes(value)) {\r\n      errors.push({\r\n        field: path || 'root',\r\n        message: `Value must be one of: ${schema.enum.join(', ')}`\r\n      })\r\n    }\r\n\r\n    // 验证对象属性\r\n    if (schema.type === 'object' && typeof value === 'object' && value !== null) {\r\n      if (schema.required) {\r\n        for (const requiredField of schema.required) {\r\n          if (!(requiredField in value)) {\r\n            errors.push({\r\n              field: path ? `${path}.${requiredField}` : requiredField,\r\n              message: 'Required field'\r\n            })\r\n          }\r\n        }\r\n      }\r\n\r\n      if (schema.properties) {\r\n        for (const [key, propertySchema] of Object.entries(schema.properties)) {\r\n          if (key in value) {\r\n            this.validateValue(\r\n              path ? `${path}.${key}` : key,\r\n              value[key],\r\n              propertySchema,\r\n              errors\r\n            )\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  public validateBuffConfig(config: any): boolean {\r\n    const schema: Schema = {\r\n      type: 'object',\r\n      required: ['id', 'name', 'description', 'duration', 'maxStacks', 'cooldown'],\r\n      properties: {\r\n        id: {\r\n          type: 'string',\r\n          minLength: 1\r\n        },\r\n        name: {\r\n          type: 'string',\r\n          minLength: 1\r\n        },\r\n        description: {\r\n          type: 'string'\r\n        },\r\n        duration: {\r\n          type: 'number',\r\n          minimum: -1\r\n        },\r\n        maxStacks: {\r\n          type: 'number',\r\n          minimum: 1\r\n        },\r\n        cooldown: {\r\n          type: 'number',\r\n          minimum: 0\r\n        },\r\n        isPermanent: {\r\n          type: 'boolean'\r\n        },\r\n        isDebuff: {\r\n          type: 'boolean'\r\n        },\r\n        parameters: {\r\n          type: 'object'\r\n        }\r\n      }\r\n    }\r\n\r\n    const result = this.validate(config, schema)\r\n    if (!result.valid) {\r\n      logger.error('Invalid buff config:', result.errors)\r\n      return false\r\n    }\r\n    return true\r\n  }\r\n}\r\n\r\nexport const schemaValidator = new SchemaValidator()\r\n","import type { IBuffScript } from '@/types/buff'\nimport type { BuffContext } from '@/core/BuffContext'\nimport { BuffErrorBoundary } from '@/core/BuffErrorBoundary'\nimport { logger } from '@/utils/logger'\n\nexport abstract class BaseBuffScript<TParams = any> implements IBuffScript<TParams> {\n  params?: TParams\n  \n  public onApply(context: BuffContext): void {\n    BuffErrorBoundary.wrap(() => {\n      this._onApply(context)\n    })\n  }\n\n  public onRemove(context: BuffContext): void {\n    BuffErrorBoundary.wrap(() => {\n      this._onRemove(context)\n      context.removeModifiers()\n    })\n  }\n\n  public onUpdate(context: BuffContext, deltaTime: number): void {\n    BuffErrorBoundary.wrap(() => {\n      this._onUpdate(context, deltaTime)\n    })\n  }\n\n  public onRefresh(context: BuffContext): void {\n    BuffErrorBoundary.wrap(() => {\n      this._onRefresh(context)\n    })\n  }\n\n  protected abstract _onApply(context: BuffContext): void\n  protected abstract _onRemove(context: BuffContext): void\n  protected abstract _onUpdate(context: BuffContext, deltaTime: number): void\n  protected abstract _onRefresh(context: BuffContext): void\n\n  protected addModifier(\n    context: BuffContext,\n    attribute: string,\n    value: number,\n    type: 'ADDITIVE' | 'MULTIPLICATIVE' | 'PERCENTAGE'\n  ): void {\n    context.addModifier(attribute, value, type)\n  }\n\n  protected getConfigValue<T>(\n    context: BuffContext,\n    key: string,\n    defaultValue: T\n  ): T {\n    return context.config.parameters?.[key] ?? defaultValue\n  }\n\n  protected log(context: BuffContext, message: string): void {\n    logger.debug(`[${context.config.id}] ${message}`)\n  }\n\n  protected triggerEvent(\n    context: BuffContext,\n    eventName: string,\n    data?: any\n  ): void {\n    context.triggerEvent(eventName, data)\n  }\n}\n","import type { Character } from '@/types/character'\r\nimport type { BuffContext } from '@/core/BuffContext'\r\n\r\nexport class BuffScriptUtils {\r\n  public static calculateDamage(\r\n    attacker: Character,\r\n    defender: Character,\r\n    baseDamage: number,\r\n    isCritical: boolean = false\r\n  ): number {\r\n    const attack = attacker.getAttribute('ATK')\r\n    const defense = defender.getAttribute('DEF')\r\n    \r\n    // 基础伤害计算\r\n    let damage = baseDamage * (attack / (attack + defense * 0.8))\r\n    \r\n    // 暴击伤害计算\r\n    if (isCritical) {\r\n      const critDmg = attacker.getAttribute('CRIT_DMG')\r\n      damage *= (1 + critDmg)\r\n    }\r\n    \r\n    // 确保伤害不低于最小值\r\n    return Math.max(1, Math.floor(damage))\r\n  }\r\n\r\n  public static calculateHealing(\r\n    character: Character,\r\n    baseHealing: number\r\n  ): number {\r\n    const level = character.level\r\n    const maxHP = character.getAttribute('HP')\r\n    \r\n    // 治疗量计算，基于角色等级和最大生命值\r\n    let healing = baseHealing * (1 + level * 0.01)\r\n    \r\n    // 确保治疗量不超过最大生命值的一定比例\r\n    const maxHealing = maxHP * 0.3\r\n    return Math.min(maxHealing, Math.floor(healing))\r\n  }\r\n\r\n  public static checkCondition(\r\n    context: BuffContext,\r\n    condition: {\r\n      type: string\r\n      attribute?: string\r\n      operator?: string\r\n      value?: number\r\n    }\r\n  ): boolean {\r\n    switch (condition.type) {\r\n      case 'HP_BELOW':\r\n        return context.getAttributeValue('HP') < condition.value!\r\n      case 'MP_BELOW':\r\n        return context.getAttributeValue('MP') < condition.value!\r\n      case 'LEVEL_ABOVE':\r\n        // 假设角色等级可以通过 context 获取\r\n        return (context.getCharacter()?.level || 0) > condition.value!\r\n      case 'HAS_BUFF':\r\n        // 假设可以检查角色是否有特定 Buff\r\n        return context.getCharacter()?.hasBuff(condition.attribute!) ?? false\r\n      default:\r\n        return true\r\n    }\r\n  }\r\n\r\n  public static getRandomValue(min: number, max: number): number {\r\n    return Math.random() * (max - min) + min\r\n  }\r\n\r\n  public static getRandomInt(min: number, max: number): number {\r\n    return Math.floor(Math.random() * (max - min + 1)) + min\r\n  }\r\n\r\n  public static calculateDuration(\r\n    baseDuration: number,\r\n    scaleFactor: number = 1,\r\n    level: number = 1\r\n  ): number {\r\n    return baseDuration * scaleFactor * (1 + level * 0.05)\r\n  }\r\n\r\n  public static calculateEffectValue(\r\n    baseValue: number,\r\n    scaleFactor: number = 1,\r\n    level: number = 1\r\n  ): number {\r\n    return baseValue * scaleFactor * (1 + level * 0.08)\r\n  }\r\n\r\n  public static formatDuration(ms: number): string {\r\n    if (ms < 1000) {\r\n      return `${ms}ms`\r\n    } else if (ms < 60000) {\r\n      return `${(ms / 1000).toFixed(1)}s`\r\n    } else {\r\n      const minutes = Math.floor(ms / 60000)\r\n      const seconds = Math.floor((ms % 60000) / 1000)\r\n      return `${minutes}m ${seconds}s`\r\n    }\r\n  }\r\n\r\n  public static isExpired(context: BuffContext): boolean {\r\n    const remaining = context.getRemainingTime()\r\n    return remaining >= 0 && remaining <= 0\r\n  }\r\n\r\n  public static canStack(context: BuffContext, maxStacks: number): boolean {\r\n    const character = context.getCharacter()\r\n    if (!character) return false\r\n    \r\n    const buffId = context.config.id\r\n    const currentStacks = character.buffs.filter(\r\n      (buffInstanceId) => buffInstanceId.includes(buffId)\r\n    ).length\r\n    \r\n    return currentStacks < maxStacks\r\n  }\r\n}\r\n","import { BaseBuffScript } from '../base/BaseBuffScript'\r\nimport type { BuffContext } from '@/core/BuffContext'\r\n\r\nexport class MountainGodBuff extends BaseBuffScript {\r\n  public static readonly BUFF_ID = 'mountain_god'\r\n\r\n  protected _onApply(context: BuffContext): void {\r\n    this.log(context, '山神降临！获得强大的力量')\r\n    \r\n    // 添加攻击力和防御力提升\r\n    const attackBonus = this.getConfigValue(context, 'attackBonus', 50)\r\n    const defenseBonus = this.getConfigValue(context, 'defenseBonus', 30)\r\n    \r\n    this.addModifier(context, 'ATK', attackBonus, 'ADDITIVE')\r\n    this.addModifier(context, 'DEF', defenseBonus, 'ADDITIVE')\r\n    \r\n    // 添加暴击率提升\r\n    this.addModifier(context, 'CRIT_RATE', 0.1, 'ADDITIVE')\r\n    \r\n    context.setVariable('initialAttackBonus', attackBonus)\r\n  }\r\n\r\n  protected _onRemove(context: BuffContext): void {\r\n    this.log(context, '山神之力消散')\r\n  }\r\n\r\n  protected _onUpdate(context: BuffContext, deltaTime: number): void {\r\n    // 每秒钟恢复少量生命值\r\n    const elapsed = context.getElapsedTime()\r\n    if (Math.floor(elapsed / 1000) > Math.floor((elapsed - deltaTime) / 1000)) {\r\n      const regeneration = this.getConfigValue(context, 'regeneration', 5)\r\n      this.log(context, `山神的祝福：恢复 ${regeneration} 生命值`)\r\n      // 这里应该调用角色的治疗方法\r\n    }\r\n  }\r\n\r\n  protected _onRefresh(context: BuffContext): void {\r\n    this.log(context, '山神之力得到强化！')\r\n    \r\n    // 刷新时增加额外的攻击力\r\n    const refreshBonus = this.getConfigValue(context, 'refreshBonus', 10)\r\n    \r\n    this.addModifier(context, 'ATK', refreshBonus, 'ADDITIVE')\r\n    \r\n    this.log(context, `获得额外 ${refreshBonus} 攻击力`)    \r\n  }\r\n}\r\n\r\n// 导出 BUFF_ID 常量\r\nexport const BUFF_ID = MountainGodBuff.BUFF_ID\r\n","import { BaseBuffScript } from '../base/BaseBuffScript'\r\nimport type { BuffContext } from '@/core/BuffContext'\r\n\r\nexport class PoisonDebuff extends BaseBuffScript {\r\n  public static readonly BUFF_ID = 'poison'\r\n\r\n  protected _onApply(context: BuffContext): void {\r\n    this.log(context, '中毒了！毒素开始侵蚀身体')\r\n    \r\n    // 降低移动速度\r\n    this.addModifier(context, 'SPD', -0.2, 'MULTIPLICATIVE')\r\n    \r\n    // 记录初始伤害值\r\n    const baseDamage = this.getConfigValue(context, 'baseDamage', 10)\r\n    context.setVariable('baseDamage', baseDamage)\r\n    context.setVariable('lastDamageTime', 0)\r\n  }\r\n\r\n  protected _onRemove(context: BuffContext): void {\r\n    this.log(context, '毒素效果消失')\r\n  }\r\n\r\n  protected _onUpdate(context: BuffContext, _deltaTime: number): void {\r\n    const elapsed = context.getElapsedTime()\r\n    const lastDamageTime = context.getVariable<number>('lastDamageTime') || 0\r\n    const damageInterval = this.getConfigValue(context, 'damageInterval', 2000)\r\n    \r\n    // 每隔一段时间造成伤害\r\n    if (elapsed - lastDamageTime >= damageInterval) {\r\n      const baseDamage = context.getVariable<number>('baseDamage') || 10\r\n      const damageMultiplier = this.getConfigValue(context, 'damageMultiplier', 1.2)\r\n      \r\n      // 计算当前伤害（随时间递增）\r\n      const stacks = Math.floor(elapsed / damageInterval)\r\n      const currentDamage = Math.floor(baseDamage * Math.pow(damageMultiplier, stacks))\r\n      \r\n      this.log(context, `毒素伤害：${currentDamage}`)\r\n      // 这里应该调用角色的伤害方法\r\n      \r\n      context.setVariable('lastDamageTime', elapsed)\r\n    }\r\n  }\r\n\r\n  protected _onRefresh(context: BuffContext): void {\r\n    this.log(context, '毒素效果增强！')\r\n    \r\n    // 刷新时增加伤害\r\n    const baseDamage = context.getVariable<number>('baseDamage') || 10\r\n    const refreshBonus = this.getConfigValue(context, 'refreshBonus', 5)\r\n    \r\n    context.setVariable('baseDamage', baseDamage + refreshBonus)\r\n    \r\n    this.log(context, `毒素伤害提升至 ${baseDamage + refreshBonus}`)\r\n  }\r\n}\r\n\r\n// 导出 BUFF_ID 常量\r\nexport const BUFF_ID = PoisonDebuff.BUFF_ID\r\n","import { BaseBuffScript } from '../base/BaseBuffScript'\r\nimport type { BuffContext } from '@/core/BuffContext'\r\n\r\nexport class BerserkBuff extends BaseBuffScript {\r\n  public static readonly BUFF_ID = 'berserk'\r\n\r\n  protected _onApply(context: BuffContext): void {\r\n    this.log(context, '陷入狂暴状态！攻击力大幅提升，但防御力降低')\r\n    \r\n    // 大幅提升攻击力\r\n    const attackBonus = this.getConfigValue(context, 'attackBonus', 100)\r\n    this.addModifier(context, 'ATK', attackBonus, 'ADDITIVE')\r\n    \r\n    // 大幅提升暴击率和暴击伤害\r\n    this.addModifier(context, 'CRIT_RATE', 0.2, 'ADDITIVE')\r\n    this.addModifier(context, 'CRIT_DMG', 0.5, 'ADDITIVE')\r\n    \r\n    // 降低防御力\r\n    this.addModifier(context, 'DEF', -0.3, 'MULTIPLICATIVE')\r\n    \r\n    context.setVariable('attackBonus', attackBonus)\r\n  }\r\n\r\n  protected _onRemove(context: BuffContext): void {\r\n    this.log(context, '狂暴状态结束，恢复平静')\r\n  }\r\n\r\n  protected _onUpdate(context: BuffContext, deltaTime: number): void {\r\n    // 每秒钟损失少量生命值（狂暴的代价）\r\n    const elapsed = context.getElapsedTime()\r\n    if (Math.floor(elapsed / 1000) > Math.floor((elapsed - deltaTime) / 1000)) {\r\n      const selfDamage = this.getConfigValue(context, 'selfDamage', 5)\r\n      this.log(context, `狂暴的代价：损失 ${selfDamage} 生命值`)\r\n      // 这里应该调用角色的伤害方法\r\n    }\r\n  }\r\n\r\n  protected _onRefresh(context: BuffContext): void {\r\n    this.log(context, '狂暴之力进一步增强！')\r\n    \r\n    // 刷新时增加额外的攻击力和暴击率\r\n    const attackBonus = this.getConfigValue(context, 'refreshAttackBonus', 20)\r\n    const critRateBonus = this.getConfigValue(context, 'refreshCritRateBonus', 0.05)\r\n    \r\n    this.addModifier(context, 'ATK', attackBonus, 'ADDITIVE')\r\n    this.addModifier(context, 'CRIT_RATE', critRateBonus, 'ADDITIVE')\r\n    \r\n    this.log(context, `获得额外 ${attackBonus} 攻击力和 ${(critRateBonus * 100).toFixed(0)}% 暴击率`)\r\n  }\r\n}\r\n\r\n// 导出 BUFF_ID 常量\r\nexport const BUFF_ID = BerserkBuff.BUFF_ID\r\n","import { BaseBuffScript } from '../base/BaseBuffScript'\r\nimport type { BuffContext } from '@/core/BuffContext'\r\n\r\nexport class HealOverTime extends BaseBuffScript {\r\n  public static readonly BUFF_ID = 'heal_over_time'\r\n\r\n  protected _onApply(context: BuffContext): void {\r\n    this.log(context, '获得持续治疗效果')\r\n    \r\n    // 记录治疗相关参数\r\n    const baseHealing = this.getConfigValue(context, 'baseHealing', 20)\r\n    const healInterval = this.getConfigValue(context, 'healInterval', 1000)\r\n    \r\n    context.setVariable('baseHealing', baseHealing)\r\n    context.setVariable('healInterval', healInterval)\r\n    context.setVariable('lastHealTime', 0)\r\n  }\r\n\r\n  protected _onRemove(context: BuffContext): void {\r\n    this.log(context, '持续治疗效果结束')\r\n  }\r\n\r\n  protected _onUpdate(context: BuffContext, _deltaTime: number): void {\r\n    const elapsed = context.getElapsedTime()\r\n    const lastHealTime = context.getVariable<number>('lastHealTime') || 0\r\n    const healInterval = context.getVariable<number>('healInterval') || 1000\r\n    \r\n    // 每隔一段时间恢复生命值\r\n    if (elapsed - lastHealTime >= healInterval) {\r\n      const baseHealing = context.getVariable<number>('baseHealing') || 20\r\n      const healingBonus = this.getConfigValue(context, 'healingBonus', 0)\r\n      \r\n      const currentHealing = baseHealing + healingBonus\r\n      \r\n      this.log(context, `持续治疗：恢复 ${currentHealing} 生命值`)\r\n      // 这里应该调用角色的治疗方法\r\n      \r\n      context.setVariable('lastHealTime', elapsed)\r\n    }\r\n  }\r\n\r\n  protected _onRefresh(context: BuffContext): void {\r\n    this.log(context, '持续治疗效果增强！')\r\n    \r\n    // 刷新时增加治疗量\r\n    const baseHealing = context.getVariable<number>('baseHealing') || 20\r\n    const refreshBonus = this.getConfigValue(context, 'refreshBonus', 5)\r\n    \r\n    context.setVariable('baseHealing', baseHealing + refreshBonus)\r\n    \r\n    this.log(context, `治疗量提升至 ${baseHealing + refreshBonus}`)\r\n  }\r\n}\r\n\r\n// 导出 BUFF_ID 常量\r\nexport const BUFF_ID = HealOverTime.BUFF_ID\r\n","import { BaseBuffScript } from '../base/BaseBuffScript'\r\nimport type { BuffContext } from '@/core/BuffContext'\r\n\r\nexport class ShieldBuff extends BaseBuffScript {\r\n  public static readonly BUFF_ID = 'shield'\r\n\r\n  protected _onApply(context: BuffContext): void {\r\n    this.log(context, '获得护盾保护')\r\n    \r\n    // 计算护盾值\r\n    const baseShield = this.getConfigValue(context, 'baseShield', 100)\r\n    const shieldScale = this.getConfigValue(context, 'shieldScale', 1)\r\n    \r\n    const character = context.getCharacter()\r\n    const maxHP = character ? character.getAttribute('HP') : 1000\r\n    const shieldValue = Math.floor(baseShield * shieldScale + maxHP * 0.1)\r\n    \r\n    // 记录护盾相关参数\r\n    context.setVariable('shieldValue', shieldValue)\r\n    context.setVariable('maxShieldValue', shieldValue)\r\n    context.setVariable('shieldRegen', this.getConfigValue(context, 'shieldRegen', 0))\r\n  }\r\n\r\n  protected _onRemove(context: BuffContext): void {\r\n    const remainingShield = context.getVariable<number>('shieldValue') || 0\r\n    this.log(context, `护盾效果消失，剩余护盾值：${remainingShield}`)\r\n  }\r\n\r\n  protected _onUpdate(context: BuffContext, deltaTime: number): void {\r\n    // 每秒钟恢复少量护盾值\r\n    const shieldRegen = context.getVariable<number>('shieldRegen') || 0\r\n    if (shieldRegen > 0) {\r\n      const elapsed = context.getElapsedTime()\r\n      if (Math.floor(elapsed / 1000) > Math.floor((elapsed - deltaTime) / 1000)) {\r\n        const currentShield = context.getVariable<number>('shieldValue') || 0\r\n        const maxShield = context.getVariable<number>('maxShieldValue') || 100\r\n        \r\n        const newShield = Math.min(currentShield + shieldRegen, maxShield)\r\n        context.setVariable('shieldValue', newShield)\r\n        \r\n        this.log(context, `护盾恢复：${shieldRegen}，当前护盾值：${newShield}`)\r\n      }\r\n    }\r\n  }\r\n\r\n  protected _onRefresh(context: BuffContext): void {\r\n    this.log(context, '护盾效果增强！')\r\n    \r\n    // 刷新时增加护盾值\r\n    const currentShield = context.getVariable<number>('shieldValue') || 0\r\n    const maxShield = context.getVariable<number>('maxShieldValue') || 100\r\n    const refreshBonus = this.getConfigValue(context, 'refreshBonus', 20)\r\n    \r\n    const newMaxShield = maxShield + refreshBonus\r\n    const newShield = currentShield + refreshBonus\r\n    \r\n    context.setVariable('shieldValue', newShield)\r\n    context.setVariable('maxShieldValue', newMaxShield)\r\n    \r\n    this.log(context, `护盾值提升至 ${newShield}/${newMaxShield}`)\r\n  }\r\n}\r\n\r\n// 导出 BUFF_ID 常量\r\nexport const BUFF_ID = ShieldBuff.BUFF_ID\r\n","// 导出所有 Buff 脚本\r\nexport * from './base/BaseBuffScript'\r\nexport * from './base/BuffScriptUtils'\r\n\r\n// 单独导出类，避免 BUFF_ID 冲突\r\nexport { MountainGodBuff } from './combat/MountainGodBuff'\r\nexport { PoisonDebuff } from './combat/PoisonDebuff'\r\nexport { BerserkBuff } from './combat/BerserkBuff'\r\nexport { HealOverTime } from './support/HealOverTime'\r\nexport { ShieldBuff } from './support/ShieldBuff'\r\n\r\n// 导出脚本映射，方便注册\r\nexport const buffScripts = {\r\n  mountain_god: () => import('./combat/MountainGodBuff'),\r\n  poison: () => import('./combat/PoisonDebuff'),\r\n  berserk: () => import('./combat/BerserkBuff'),\r\n  heal_over_time: () => import('./support/HealOverTime'),\r\n  shield: () => import('./support/ShieldBuff')\r\n}\r\n\r\nexport type BuffScriptType = keyof typeof buffScripts\r\n","// 核心引擎导出\nexport * from './core/BuffSystem'\nexport * from './core/BuffScriptRegistry'\nexport * from './core/BuffScriptLoader'\nexport * from './core/ModifierStack'\nexport * from './core/BuffContext'\nexport * from './core/BuffErrorBoundary'\nexport { GameBattleSystem as BattleSystem } from './core/BattleSystem'\n\n// 类型定义导出\nexport * from './types/buff'\nexport * from './types/character'\nexport * from './types/modifier'\nexport * from './types/enemy'\nexport * from './types/battle'\n\n// 工具函数导出\nexport * from './utils/logger'\nexport * from './utils/perf-monitor'\nexport * from './utils/object-pool'\nexport * from './utils/schema-validator'\n\n// 业务脚本导出\nexport * from './scripts'\n\n// 模块初始化函数\nexport async function initializeBuffSystem(): Promise<void> {\n  try {\n    // 加载所有 Buff 脚本\n    const { BuffScriptLoader } = await import('./core/BuffScriptLoader')\n    await BuffScriptLoader.getInstance().loadScripts()\n\n    console.log('Buff system initialized successfully')\n  } catch (error) {\n    console.error('Failed to initialize buff system:', error)\n  }\n}\n"],"names":["Logger","config","__publicField","level","levels","message","data","formatted","prefix","logger","_BuffScriptRegistry","scriptId","factory","metadata","entry","e","entries","BuffScriptRegistry","BuffContext","characterId","instanceId","key","value","attribute","type","BuffSystem","character","eventName","ModifierStack","buffInstanceId","stack","filtered","modifier","baseValue","modifiers","result","additiveSum","multiplicativeSum","allModifiers","count","BuffErrorBoundary","fn","error","maxRetries","retries","_BuffSystem","reactive","buffId","script","context","buffInstance","instance","deltaTime","toRemove","instances","_BuffScriptLoader","MountainGodBuff","MountainGodBuff$1","PoisonDebuff","PoisonDebuff$1","BerserkBuff","BerserkBuff$1","HealOverTime","HealOverTime$1","ShieldBuff","ShieldBuff$1","registry","id","BuffScriptLoader","BaseBattleAI","battleState","participant","battleAnalysis","skillId","skillError","attackError","allies","p","enemies","teamHealth","sum","teamMaxHealth","teamHealthPercent","highestThreatEnemy","max","enemy","threat","needsHealing","_participant","targetsWithThreat","target","a","b","_battleState","healthPercent","energyPercent","energy","maxEnergy","analysis","skills","healSkill","s","damageSkill","smallSkill","ultimateSkill","skill","targetId","action","CharacterAI","attackSkills","EnemyAI","characters","BattleAIFactory","BaseBattleParticipant","amount","damage","healAmount","originalHealth","SimpleBattleCharacter","attributes","buffs","index","SimpleBattleEnemy","stats","activeSkills","enemyCurrentHealth","enemyMaxHealth","_GameBattleSystem","participantsInfo","battleId","participants","turnOrder","info","aiInstances","ai","battleData","battle","currentParticipantId","defaultAi","aliveCharacters","aliveEnemies","source","energyCost","actualDamage","actualHeal","winner","participantId","GameBattleSystem","PerformanceMonitor","name","start","duration","metric","perfMonitor","measure","ObjectPool","options","obj","i","createBuffContextPool","SchemaValidator","schema","errors","path","requiredField","propertySchema","schemaValidator","BaseBuffScript","defaultValue","_a","BuffScriptUtils","attacker","defender","baseDamage","isCritical","attack","defense","critDmg","baseHealing","maxHP","healing","maxHealing","condition","_b","min","baseDuration","scaleFactor","ms","minutes","seconds","remaining","maxStacks","attackBonus","defenseBonus","elapsed","regeneration","refreshBonus","BUFF_ID","_deltaTime","lastDamageTime","damageInterval","damageMultiplier","stacks","currentDamage","selfDamage","critRateBonus","healInterval","lastHealTime","healingBonus","currentHealing","baseShield","shieldScale","shieldValue","remainingShield","shieldRegen","currentShield","maxShield","newShield","newMaxShield","buffScripts","initializeBuffSystem","BuffScriptLoader$1"],"mappings":"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"}